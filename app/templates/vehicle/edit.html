{% extends 'base.html' %}
{% from 'macros/controls.html' import input_field, select_field with context %}

{% block page_title %}
  {{ t('vehicle_edit.page_title_new') if is_new else t('vehicle_edit.page_title_edit') }}
{% endblock %}

{% block content %}
<form method="post" action="{{ form_action }}" class="card p-3" enctype="multipart/form-data" id="vehicle-form">
  <div class="row g-3">
    {% for field in vehicle_fields %}
      <div class="{{ 'col-12' if field.type == 'textarea' else 'col-md-4' }}">
        {% if field.type == 'select' %}
          {{ select_field('vehicle', field.name, t(field.label_key), field.name, vehicle[field.name], master_data[field.options_key]) }}
        {% else %}
          {{ input_field('vehicle', field.name, t(field.label_key), field.name, vehicle[field.name], field.type) }}
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <div class="row g-3 mt-3">
    <div class="col-12">
      <h5 class="mb-2">{{ t('vehicle_status.section_title') }}</h5>
    </div>
    {% for field in status_fields %}
      <div class="col-md-4">
        {% if field.type == 'select' %}
          {{ select_field('vehicle_status', field.name, t(field.label_key), field.name, status_data[field.name], master_data[field.options_key]) }}
        {% else %}
          {{ input_field('vehicle_status', field.name, t(field.label_key), field.name, status_data[field.name], field.type) }}
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <div class="row g-3 mt-2">
    {% if field_perm.can_view('vehicle', 'legal_doc') %}
      <div class="col-12">
        <h5 class="mb-2">{{ t('vehicle_edit.legal_doc_title') }}</h5>
        {% if field_perm.can_edit('vehicle', 'legal_doc') %}
          <input class="form-control" type="file" name="legal_doc_files" id="legal-doc-input" multiple accept="image/*">
        {% endif %}
        <input type="hidden" name="remove_legal_docs" id="remove-legal-docs">
        <div class="d-flex flex-wrap gap-2 mt-2" id="legal-doc-thumbs">
          {% for filename in legal_docs %}
            <div class="thumb-item" data-filename="{{ filename }}">
              <a href="{{ url_for('ui.vehicle_image', vin=vehicle.vin, category='legal_doc', filename=filename) }}" class="thumb-link">
                <img src="{{ url_for('ui.vehicle_image', vin=vehicle.vin, category='legal_doc', filename=filename) }}" alt="{{ filename }}">
              </a>
              {% if field_perm.can_edit('vehicle', 'legal_doc') %}
                <button type="button" class="thumb-remove" data-target="legal" aria-label="{{ t('vehicle_edit.remove') }}">×</button>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if field_perm.can_view('vehicle', 'vehicle_photo') %}
      <div class="col-12">
        <h5 class="mb-2">{{ t('vehicle_edit.vehicle_photo_title') }}</h5>
        {% if field_perm.can_edit('vehicle', 'vehicle_photo') %}
          <input class="form-control" type="file" name="vehicle_photo_files" id="vehicle-photo-input" multiple accept="image/*">
        {% endif %}
        <input type="hidden" name="remove_vehicle_photos" id="remove-vehicle-photos">
        <input type="hidden" name="primary_vehicle_photo" id="primary-vehicle-photo" value="">
        <div class="d-flex flex-wrap gap-2 mt-2" id="vehicle-photo-thumbs">
          {% for photo in vehicle_photos %}
            {% set is_primary = photo.is_primary %}
            <div class="thumb-item {% if is_primary or (not has_primary_photo and loop.first) %}is-primary{% endif %}" data-filename="{{ photo.filename }}" data-is-primary="{{ 1 if is_primary else 0 }}">
              <button type="button" class="thumb-primary" aria-label="{{ t('vehicle_edit.set_primary') }}">
                <svg viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M12 2.4l2.9 5.88 6.49.95-4.69 4.57 1.11 6.47L12 17.9l-5.81 3.37 1.11-6.47-4.69-4.57 6.49-.95L12 2.4z"/>
                </svg>
              </button>
              <a href="{{ url_for('ui.vehicle_image', vin=vehicle.vin, category='vehicle_photo', filename=photo.filename) }}" class="thumb-link">
                <img src="{{ url_for('ui.vehicle_image', vin=vehicle.vin, category='vehicle_photo', filename=photo.filename) }}" alt="{{ photo.filename }}">
              </a>
              {% if field_perm.can_edit('vehicle', 'vehicle_photo') %}
                <button type="button" class="thumb-remove" data-target="photo" aria-label="{{ t('vehicle_edit.remove') }}">×</button>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>

  <div class="d-flex justify-content-end gap-2 mt-2">
    <button class="btn btn-outline-secondary" type="button" id="cancel-button">
      {{ t('vehicle_edit.cancel') }}
    </button>
    {% if perms.can('vehicle','edit') %}
      {% if not is_new %}
        <a class="btn btn-outline-primary" href="{{ url_for('ui.vehicle_new', source_id=vehicle.id, lang=lang) }}">
          {{ t('vehicle_edit.save_as') }}
        </a>
      {% endif %}
      <button class="btn btn-primary" id="save-button">{{ t('vehicle_edit.save') }}</button>
    {% endif %}
  </div>
</form>

<style>
  .thumb-item { position: relative; display: inline-flex; align-items: center; }
  .thumb-item img { width: 96px; height: 72px; object-fit: cover; border-radius: 6px; }
  .thumb-item.is-new img { border: 2px solid #28a745; }
  .thumb-item.is-removed img { border: 2px solid #dc3545; opacity: 0.55; }
  .thumb-item.is-primary img { border: 2px solid #f4c542; }
  .thumb-primary {
    position: absolute;
    top: -6px;
    left: -6px;
    width: 22px;
    height: 22px;
    border: 1px solid #f4c542;
    border-radius: 50%;
    background: #fff;
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  .thumb-primary svg {
    width: 14px;
    height: 14px;
    fill: transparent;
    stroke: #f4c542;
    stroke-width: 1.6;
  }
  .thumb-item.is-primary .thumb-primary svg {
    fill: #f4c542;
  }
  .thumb-remove {
    position: absolute;
    top: -6px;
    right: -6px;
    border: none;
    background: #dc3545;
    color: #fff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    line-height: 20px;
    text-align: center;
    padding: 0;
  }
  .field-dirty .ac-input { color: #dc3545; }
  .image-preview-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.15);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1050;
  }
  .image-preview-overlay.is-active { display: flex; }
  .image-preview-content {
    position: relative;
    max-width: min(90vw, 1000px);
    max-height: 90vh;
  }
  .image-preview-content img {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
    transform-origin: center center;
  }
  .image-preview-close {
    position: absolute;
    top: -12px;
    right: -12px;
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 50%;
    background: #fff;
    color: #333;
    font-size: 18px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }
</style>

<div class="image-preview-overlay" id="image-preview-overlay">
  <div class="image-preview-content">
    <button type="button" class="image-preview-close" aria-label="Close preview">×</button>
    <img src="" alt="preview" id="image-preview-img">
  </div>
</div>

<script>
  const form = document.getElementById('vehicle-form');
  let isDirty = false;

  const formFields = Array.from(form.querySelectorAll('.ac-input'));
  formFields.forEach((field) => {
    field.dataset.initialValue = field.value || '';
  });
  updateDirtyState();

  const brandSelect = form.querySelector('select[name="brand_id"]');
  const modelSelect = form.querySelector('select[name="model_id"]');

  function filterModels() {
    if (!brandSelect || !modelSelect) {
      return;
    }
    const selectedBrand = brandSelect.value;
    const options = Array.from(modelSelect.querySelectorAll('option'));
    let hasSelected = false;
    options.forEach((option) => {
      if (!option.value) {
        option.hidden = false;
        return;
      }
      const brandId = option.dataset.brandId;
      const matches = !selectedBrand || brandId === selectedBrand;
      option.hidden = !matches;
      if (matches && option.selected) {
        hasSelected = true;
      }
    });
    if (!hasSelected && selectedBrand) {
      modelSelect.value = '';
    }
  }

  if (brandSelect) {
    brandSelect.addEventListener('change', filterModels);
  }
  filterModels();

  function updateDirtyState() {
    formFields.forEach((field) => {
      const current = field.value || '';
      const initial = field.dataset.initialValue || '';
      const wrapper = field.closest('.ac-field-editable');
      if (!wrapper) {
        return;
      }
      if (current !== initial) {
        wrapper.classList.add('field-dirty');
      } else {
        wrapper.classList.remove('field-dirty');
      }
    });
  }

  form.addEventListener('change', () => {
    isDirty = true;
    updateDirtyState();
  });

  form.addEventListener('input', () => {
    isDirty = true;
    updateDirtyState();
  });

  form.addEventListener('submit', () => {
    isDirty = false;
  });

  window.addEventListener('beforeunload', (event) => {
    if (isDirty) {
      event.preventDefault();
      event.returnValue = '';
    }
  });

  const removeLegalInput = document.getElementById('remove-legal-docs');
  const removePhotoInput = document.getElementById('remove-vehicle-photos');
  const primaryPhotoInput = document.getElementById('primary-vehicle-photo');
  const initialLegalThumbs = document.getElementById('legal-doc-thumbs')?.innerHTML || '';
  const initialPhotoThumbs = document.getElementById('vehicle-photo-thumbs')?.innerHTML || '';
  const hasPrimaryPhoto = {{ 'true' if has_primary_photo else 'false' }};

  if (primaryPhotoInput && hasPrimaryPhoto) {
    const initialPrimary = document.querySelector('#vehicle-photo-thumbs .thumb-item[data-is-primary="1"]')?.dataset.filename;
    if (initialPrimary) {
      primaryPhotoInput.value = initialPrimary;
    }
  }

  function updateRemoveList(input, name) {
    const existing = input.value ? input.value.split(',') : [];
    if (!existing.includes(name)) {
      existing.push(name);
      input.value = existing.join(',');
    }
  }

  function setupRemoveButtons(containerId, hiddenInput) {
    const container = document.getElementById(containerId);
    if (!container || !hiddenInput) {
      return;
    }
    container.addEventListener('click', (event) => {
      if (!event.target.classList.contains('thumb-remove')) {
        return;
      }
      const item = event.target.closest('.thumb-item');
      if (!item) {
        return;
      }
      const filename = item.dataset.filename;
      if (filename) {
        updateRemoveList(hiddenInput, filename);
        if (primaryPhotoInput && primaryPhotoInput.value === filename) {
          primaryPhotoInput.value = '';
        }
      }
      item.classList.add('is-removed');
      const removeBtn = item.querySelector('.thumb-remove');
      if (removeBtn) {
        removeBtn.disabled = true;
      }
      isDirty = true;
    });
  }

  setupRemoveButtons('legal-doc-thumbs', removeLegalInput);
  setupRemoveButtons('vehicle-photo-thumbs', removePhotoInput);

  function syncPrimarySelection(filename) {
    if (!primaryPhotoInput) {
      return;
    }
    const thumbs = Array.from(document.querySelectorAll('#vehicle-photo-thumbs .thumb-item'));
    thumbs.forEach((thumb) => {
      thumb.classList.toggle('is-primary', thumb.dataset.filename === filename);
    });
    primaryPhotoInput.value = filename;
  }

  document.getElementById('vehicle-photo-thumbs')?.addEventListener('click', (event) => {
    const primaryButton = event.target.closest('.thumb-primary');
    if (!primaryButton) {
      return;
    }
    const item = primaryButton.closest('.thumb-item');
    if (!item || item.classList.contains('is-removed')) {
      return;
    }
    const filename = item.dataset.filename;
    if (filename) {
      syncPrimarySelection(filename);
      isDirty = true;
    }
  });

  function buildPreview(file, container, onRemove) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'thumb-item is-new';
      wrapper.dataset.filename = file.name;
      const primaryBtn = document.createElement('button');
      primaryBtn.type = 'button';
      primaryBtn.className = 'thumb-primary';
      primaryBtn.setAttribute('aria-label', '{{ t("vehicle_edit.set_primary") }}');
      primaryBtn.innerHTML = '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M12 2.4l2.9 5.88 6.49.95-4.69 4.57 1.11 6.47L12 17.9l-5.81 3.37 1.11-6.47-4.69-4.57 6.49-.95L12 2.4z"/></svg>';
      primaryBtn.addEventListener('click', () => {
        if (wrapper.classList.contains('is-removed')) {
          return;
        }
        syncPrimarySelection(file.name);
        isDirty = true;
      });
      const link = document.createElement('a');
      link.href = e.target.result;
      link.className = 'thumb-link';
      const img = document.createElement('img');
      img.src = e.target.result;
      link.appendChild(img);
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'thumb-remove';
      removeBtn.setAttribute('aria-label', '{{ t("vehicle_edit.remove") }}');
      removeBtn.textContent = '×';
      removeBtn.addEventListener('click', () => {
        wrapper.classList.add('is-removed');
        removeBtn.disabled = true;
        if (primaryPhotoInput && primaryPhotoInput.value === file.name) {
          primaryPhotoInput.value = '';
        }
        if (onRemove) {
          onRemove();
        }
        isDirty = true;
      });
      wrapper.appendChild(primaryBtn);
      wrapper.appendChild(link);
      wrapper.appendChild(removeBtn);
      container.appendChild(wrapper);
    };
    reader.readAsDataURL(file);
  }

  const fileResetters = [];
  function bindFileInput(inputId, containerId) {
    const input = document.getElementById(inputId);
    const container = document.getElementById(containerId);
    if (!input || !container) {
      return;
    }
    let fileItems = [];
    let counter = 0;

    const syncFiles = () => {
      const dt = new DataTransfer();
      fileItems.forEach((item) => {
        dt.items.add(item.file);
      });
      input.files = dt.files;
    };

    input.addEventListener('change', () => {
      const files = Array.from(input.files || []);
      files.forEach((file) => {
        const id = counter++;
        fileItems.push({ id, file });
        buildPreview(file, container, () => {
          fileItems = fileItems.filter((item) => item.id !== id);
          syncFiles();
        });
      });
      syncFiles();
      isDirty = true;
    });
    fileResetters.push(() => {
      fileItems = [];
      counter = 0;
      const dt = new DataTransfer();
      input.files = dt.files;
    });
  }

  bindFileInput('legal-doc-input', 'legal-doc-thumbs');
  bindFileInput('vehicle-photo-input', 'vehicle-photo-thumbs');

  const overlay = document.getElementById('image-preview-overlay');
  const overlayImg = document.getElementById('image-preview-img');
  const overlayClose = overlay?.querySelector('.image-preview-close');
  let previewScale = 1;

  function openPreview(src) {
    if (!overlay || !overlayImg) {
      return;
    }
    overlayImg.src = src;
    previewScale = 1;
    overlayImg.style.transform = 'scale(1)';
    overlay.classList.add('is-active');
  }

  function closePreview() {
    if (!overlay || !overlayImg) {
      return;
    }
    overlay.classList.remove('is-active');
    overlayImg.src = '';
    overlayImg.style.transform = 'scale(1)';
  }

  document.addEventListener('click', (event) => {
    const link = event.target.closest('.thumb-link');
    if (!link) {
      return;
    }
    event.preventDefault();
    openPreview(link.href);
  });

  overlay?.addEventListener('click', (event) => {
    if (event.target === overlay) {
      closePreview();
    }
  });

  overlayClose?.addEventListener('click', closePreview);

  overlayImg?.addEventListener('wheel', (event) => {
    event.preventDefault();
    const direction = event.deltaY > 0 ? -1 : 1;
    previewScale = Math.min(5, Math.max(0.2, previewScale + direction * 0.1));
    overlayImg.style.transform = `scale(${previewScale})`;
  });

  document.getElementById('cancel-button')?.addEventListener('click', () => {
    form.reset();
    formFields.forEach((field) => {
      field.value = field.dataset.initialValue || '';
    });
    removeLegalInput.value = '';
    removePhotoInput.value = '';
    const legalThumbs = document.getElementById('legal-doc-thumbs');
    const photoThumbs = document.getElementById('vehicle-photo-thumbs');
    if (legalThumbs) {
      legalThumbs.innerHTML = initialLegalThumbs;
    }
    if (photoThumbs) {
      photoThumbs.innerHTML = initialPhotoThumbs;
    }
    if (primaryPhotoInput) {
      const currentPrimary = document.querySelector('#vehicle-photo-thumbs .thumb-item.is-primary')?.dataset.filename || '';
      primaryPhotoInput.value = currentPrimary;
    }
    fileResetters.forEach((reset) => reset());
    isDirty = false;
    updateDirtyState();
  });
</script>
{% endblock %}
