{% extends 'base.html' %}
{% from 'macros/controls.html' import input_field with context %}

{% block page_title %}
  {{ t('vehicle_edit.page_title_new') if is_new else t('vehicle_edit.page_title_edit') }}
{% endblock %}

{% block content %}
<form method="post" action="{{ form_action }}" class="card p-3" enctype="multipart/form-data" id="vehicle-form">
  <div class="row g-3">
    {% for field in vehicle_fields %}
      <div class="{{ 'col-12' if field.type == 'textarea' else 'col-md-4' }}">
        {{ input_field('vehicle', field.name, t(field.label_key), field.name, vehicle[field.name], field.type) }}
      </div>
    {% endfor %}
  </div>

  <div class="row g-3 mt-2">
    {% if field_perm.can_view('vehicle', 'legal_doc') %}
      <div class="col-12">
        <h5 class="mb-2">{{ t('vehicle_edit.legal_doc_title') }}</h5>
        {% if field_perm.can_edit('vehicle', 'legal_doc') %}
          <input class="form-control" type="file" name="legal_doc_files" id="legal-doc-input" multiple accept="image/*">
        {% endif %}
        <input type="hidden" name="remove_legal_docs" id="remove-legal-docs">
        <div class="d-flex flex-wrap gap-2 mt-2" id="legal-doc-thumbs">
          {% for filename in legal_docs %}
            <div class="thumb-item" data-filename="{{ filename }}">
              <a href="{{ url_for('ui.vehicle_image', vin=vehicle.vin, category='legal_doc', filename=filename) }}" class="thumb-link">
                <img src="{{ url_for('ui.vehicle_image', vin=vehicle.vin, category='legal_doc', filename=filename) }}" alt="{{ filename }}">
              </a>
              {% if field_perm.can_edit('vehicle', 'legal_doc') %}
                <button type="button" class="thumb-remove" data-target="legal" aria-label="{{ t('vehicle_edit.remove') }}">×</button>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if field_perm.can_view('vehicle', 'vehicle_photo') %}
      <div class="col-12">
        <h5 class="mb-2">{{ t('vehicle_edit.vehicle_photo_title') }}</h5>
        {% if field_perm.can_edit('vehicle', 'vehicle_photo') %}
          <input class="form-control" type="file" name="vehicle_photo_files" id="vehicle-photo-input" multiple accept="image/*">
        {% endif %}
        <input type="hidden" name="remove_vehicle_photos" id="remove-vehicle-photos">
        <div class="d-flex flex-wrap gap-2 mt-2" id="vehicle-photo-thumbs">
          {% for filename in vehicle_photos %}
            <div class="thumb-item" data-filename="{{ filename }}">
              <a href="{{ url_for('ui.vehicle_image', vin=vehicle.vin, category='vehicle_photo', filename=filename) }}" class="thumb-link">
                <img src="{{ url_for('ui.vehicle_image', vin=vehicle.vin, category='vehicle_photo', filename=filename) }}" alt="{{ filename }}">
              </a>
              {% if field_perm.can_edit('vehicle', 'vehicle_photo') %}
                <button type="button" class="thumb-remove" data-target="photo" aria-label="{{ t('vehicle_edit.remove') }}">×</button>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </div>

  <div class="d-flex justify-content-end gap-2 mt-2">
    <a class="btn btn-outline-secondary" href="{{ cancel_url }}">
      {{ t('vehicle_edit.cancel') }}
    </a>
    {% if perms.can('vehicle','edit') %}
      {% if not is_new %}
        <a class="btn btn-outline-primary" href="{{ url_for('ui.vehicle_new', source_id=vehicle.id, lang=lang) }}">
          {{ t('vehicle_edit.save_as') }}
        </a>
      {% endif %}
      <button class="btn btn-primary" id="save-button">{{ t('vehicle_edit.save') }}</button>
    {% endif %}
  </div>
</form>

<style>
  .thumb-item { position: relative; display: inline-flex; align-items: center; }
  .thumb-item img { width: 96px; height: 72px; object-fit: cover; border-radius: 6px; }
  .thumb-item.is-new img { border: 2px solid #28a745; }
  .thumb-item.is-removed img { border: 2px solid #dc3545; opacity: 0.55; }
  .thumb-remove {
    position: absolute;
    top: -6px;
    right: -6px;
    border: none;
    background: #dc3545;
    color: #fff;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 12px;
    line-height: 20px;
    text-align: center;
    padding: 0;
  }
  .field-dirty .ac-input { color: #dc3545; }
  .image-preview-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.15);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1050;
  }
  .image-preview-overlay.is-active { display: flex; }
  .image-preview-content {
    position: relative;
    max-width: min(90vw, 1000px);
    max-height: 90vh;
  }
  .image-preview-content img {
    max-width: 100%;
    max-height: 90vh;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
  }
  .image-preview-close {
    position: absolute;
    top: -12px;
    right: -12px;
    width: 28px;
    height: 28px;
    border: none;
    border-radius: 50%;
    background: #fff;
    color: #333;
    font-size: 18px;
    line-height: 28px;
    text-align: center;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
  }
</style>

<div class="image-preview-overlay" id="image-preview-overlay">
  <div class="image-preview-content">
    <button type="button" class="image-preview-close" aria-label="Close preview">×</button>
    <img src="" alt="preview" id="image-preview-img">
  </div>
</div>

<script>
  const form = document.getElementById('vehicle-form');
  let isDirty = false;

  const formFields = Array.from(form.querySelectorAll('.ac-input'));
  formFields.forEach((field) => {
    field.dataset.initialValue = field.value || '';
  });

  function updateDirtyState() {
    formFields.forEach((field) => {
      const current = field.value || '';
      const initial = field.dataset.initialValue || '';
      const wrapper = field.closest('.ac-field-editable');
      if (!wrapper) {
        return;
      }
      if (current !== initial) {
        wrapper.classList.add('field-dirty');
      } else {
        wrapper.classList.remove('field-dirty');
      }
    });
  }

  form.addEventListener('change', () => {
    isDirty = true;
    updateDirtyState();
  });

  form.addEventListener('input', () => {
    isDirty = true;
    updateDirtyState();
  });

  form.addEventListener('submit', () => {
    isDirty = false;
  });

  window.addEventListener('beforeunload', (event) => {
    if (isDirty) {
      event.preventDefault();
      event.returnValue = '';
    }
  });

  const removeLegalInput = document.getElementById('remove-legal-docs');
  const removePhotoInput = document.getElementById('remove-vehicle-photos');

  function updateRemoveList(input, name) {
    const existing = input.value ? input.value.split(',') : [];
    if (!existing.includes(name)) {
      existing.push(name);
      input.value = existing.join(',');
    }
  }

  function setupRemoveButtons(containerId, hiddenInput) {
    const container = document.getElementById(containerId);
    if (!container || !hiddenInput) {
      return;
    }
    container.addEventListener('click', (event) => {
      if (!event.target.classList.contains('thumb-remove')) {
        return;
      }
      const item = event.target.closest('.thumb-item');
      if (!item) {
        return;
      }
      const filename = item.dataset.filename;
      if (filename) {
        updateRemoveList(hiddenInput, filename);
      }
      item.classList.add('is-removed');
      const removeBtn = item.querySelector('.thumb-remove');
      if (removeBtn) {
        removeBtn.disabled = true;
      }
      isDirty = true;
    });
  }

  setupRemoveButtons('legal-doc-thumbs', removeLegalInput);
  setupRemoveButtons('vehicle-photo-thumbs', removePhotoInput);

  function buildPreview(file, container, onRemove) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'thumb-item is-new';
      const link = document.createElement('a');
      link.href = e.target.result;
      link.className = 'thumb-link';
      const img = document.createElement('img');
      img.src = e.target.result;
      link.appendChild(img);
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'thumb-remove';
      removeBtn.setAttribute('aria-label', '{{ t("vehicle_edit.remove") }}');
      removeBtn.textContent = '×';
      removeBtn.addEventListener('click', () => {
        wrapper.remove();
        if (onRemove) {
          onRemove();
        }
        isDirty = true;
      });
      wrapper.appendChild(link);
      wrapper.appendChild(removeBtn);
      container.appendChild(wrapper);
    };
    reader.readAsDataURL(file);
  }

  function bindFileInput(inputId, containerId) {
    const input = document.getElementById(inputId);
    const container = document.getElementById(containerId);
    if (!input || !container) {
      return;
    }
    let fileItems = [];
    let counter = 0;

    const syncFiles = () => {
      const dt = new DataTransfer();
      fileItems.forEach((item) => {
        dt.items.add(item.file);
      });
      input.files = dt.files;
    };

    input.addEventListener('change', () => {
      const files = Array.from(input.files || []);
      files.forEach((file) => {
        const id = counter++;
        fileItems.push({ id, file });
        buildPreview(file, container, () => {
          fileItems = fileItems.filter((item) => item.id !== id);
          syncFiles();
        });
      });
      syncFiles();
      isDirty = true;
    });
  }

  bindFileInput('legal-doc-input', 'legal-doc-thumbs');
  bindFileInput('vehicle-photo-input', 'vehicle-photo-thumbs');

  const overlay = document.getElementById('image-preview-overlay');
  const overlayImg = document.getElementById('image-preview-img');
  const overlayClose = overlay?.querySelector('.image-preview-close');

  function openPreview(src) {
    if (!overlay || !overlayImg) {
      return;
    }
    overlayImg.src = src;
    overlay.classList.add('is-active');
  }

  function closePreview() {
    if (!overlay || !overlayImg) {
      return;
    }
    overlay.classList.remove('is-active');
    overlayImg.src = '';
  }

  document.addEventListener('click', (event) => {
    const link = event.target.closest('.thumb-link');
    if (!link) {
      return;
    }
    event.preventDefault();
    openPreview(link.href);
  });

  overlay?.addEventListener('click', (event) => {
    if (event.target === overlay) {
      closePreview();
    }
  });

  overlayClose?.addEventListener('click', closePreview);
</script>
{% endblock %}
