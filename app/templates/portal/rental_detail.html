{% extends 'portal/base.html' %}

{% set brand_label = (vehicle.brand_jp if lang == 'jp' else vehicle.brand_cn) or '-' %}
{% set model_label = (vehicle.model_jp if lang == 'jp' else vehicle.model_cn) or '-' %}

{% block page_title %}{{ t('portal.rental_detail_title') }}{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
<div class="mb-3">
  <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('portal.portal_rentals', lang=lang) }}">
    {{ t('portal.rental_back') }}
  </a>
</div>

<div class="row g-4">
  <div class="col-lg-7">
    <div class="card p-3">
      <h5 class="mb-3">{{ t('portal.rental_gallery_title') }}</h5>
      {% if vehicle_photos %}
        {% set initial_photo = cover_filename or vehicle_photos[0].filename %}
        <div class="mb-3">
          <img id="rental-main-image" class="img-fluid rounded"
               src="{{ url_for('portal.portal_vehicle_image', vin=vehicle.vin, category='vehicle_photo', filename=initial_photo) }}"
               alt="{{ brand_label }} {{ model_label }}">
        </div>
        <div class="d-flex flex-wrap gap-2" id="rental-photo-thumbs">
          {% for photo in vehicle_photos %}
            <button type="button" class="btn p-0 border-0 rental-thumb" data-filename="{{ photo.filename }}">
              <img class="rounded" style="width: 96px; height: 72px; object-fit: cover;"
                   src="{{ url_for('portal.portal_vehicle_image', vin=vehicle.vin, category='vehicle_photo', filename=photo.filename) }}"
                   alt="{{ photo.filename }}">
            </button>
          {% endfor %}
        </div>
        <p class="text-muted small mt-2 mb-0">{{ t('portal.rental_thumbnail_hint') }}</p>
      {% else %}
        <div class="alert alert-secondary mb-0">{{ t('portal.rental_no_photos') }}</div>
      {% endif %}
    </div>
  </div>
  <div class="col-lg-5">
    <div class="card p-3 mb-3">
      <h5 class="mb-2">{{ brand_label }} / {{ model_label }}</h5>
      <div class="text-muted">{{ t('portal.rentals_mileage') }}: {{ status.mileage if status.mileage is not none else '-' }} km</div>
      <div class="text-muted">{{ t('portal.rental_year_label') }}: {{ vehicle.model_year_ad or '-' }}</div>
    </div>
    <div class="card p-3">
      <h5 class="mb-2">{{ t('portal.rental_description_title') }}</h5>
      {% if vehicle.note %}
        <p class="mb-0">{{ vehicle.note }}</p>
      {% else %}
        <p class="text-muted mb-0">{{ t('portal.rental_description_empty') }}</p>
      {% endif %}
    </div>
    <div class="card p-3 mt-3">
      <h5 class="mb-3">{{ t('portal.rental_pricing_title') }}</h5>
      <div class="row g-2 small">
        <div class="col-6 text-muted">{{ t('portal.rental_base_price_label') }}</div>
        <div class="col-6 text-end">{{ pricing.daily_price if pricing and pricing.daily_price is not none else '-' }} {{ t('portal.rental_price_unit') }}</div>
        <div class="col-6 text-muted">{{ t('portal.rental_deposit_label') }}</div>
        <div class="col-6 text-end">{{ pricing.deposit_amount if pricing and pricing.deposit_amount is not none else '-' }}</div>
        <div class="col-6 text-muted">{{ t('portal.rental_insurance_label') }}</div>
        <div class="col-6 text-end">{{ pricing.insurance_per_day if pricing and pricing.insurance_per_day is not none else '-' }}</div>
        <div class="col-6 text-muted">{{ t('portal.rental_free_km_label') }}</div>
        <div class="col-6 text-end">{{ pricing.free_km_per_day if pricing and pricing.free_km_per_day is not none else '-' }}</div>
        <div class="col-6 text-muted">{{ t('portal.rental_extra_km_label') }}</div>
        <div class="col-6 text-end">{{ pricing.extra_km_price if pricing and pricing.extra_km_price is not none else '-' }}</div>
        <div class="col-6 text-muted">{{ t('portal.rental_cleaning_fee_label') }}</div>
        <div class="col-6 text-end">{{ pricing.cleaning_fee if pricing and pricing.cleaning_fee is not none else '-' }}</div>
        <div class="col-6 text-muted">{{ t('portal.rental_late_fee_label') }}</div>
        <div class="col-6 text-end">{{ pricing.late_fee_per_day if pricing and pricing.late_fee_per_day is not none else '-' }}</div>
        <div class="col-6 text-muted">{{ t('portal.rental_tax_rate_label') }}</div>
        <div class="col-6 text-end">{{ pricing.tax_rate if pricing and pricing.tax_rate is not none else '-' }}%</div>
      </div>
    </div>
    <div class="card p-3 mt-3">
      <h5 class="mb-3">{{ t('portal.rental_apply_section_title') }}</h5>
      {% if submitted %}
        <div class="alert alert-success">{{ t('portal.rental_submit_success') }}</div>
      {% endif %}
      {% if error == 'dates' %}
        <div class="alert alert-warning">{{ t('portal.rental_date_required') }}</div>
      {% endif %}
      {% if not current_customer.is_authenticated %}
        <div class="alert alert-warning">{{ t('portal.rental_login_hint') }}</div>
      {% endif %}
      <form method="post" action="{{ url_for('portal.portal_rental_request', vehicle_id=vehicle.id, lang=lang) }}">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">{{ t('portal.rental_date_start') }}</label>
            <input type="date" class="form-control" name="start_date" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">{{ t('portal.rental_date_end') }}</label>
            <input type="date" class="form-control" name="end_date" required>
          </div>
          <div class="col-12">
            <label class="form-label">{{ t('portal.rental_location_label') }}</label>
            <div id="rental-map" class="border rounded" style="height: 220px;"></div>
            <div class="text-muted small mt-2" id="rental-location-hint">{{ t('portal.rental_location_hint') }}</div>
            <input type="hidden" name="delivery_lat" id="delivery-lat">
            <input type="hidden" name="delivery_lng" id="delivery-lng">
            <input type="hidden" name="delivery_address" id="delivery-address">
          </div>
          <div class="col-12">
            <label class="form-label">{{ t('portal.rental_services_label') }}</label>
            <div class="d-flex flex-column gap-2">
              {% for service in rental_services %}
                <label class="form-check-label">
                  <input class="form-check-input me-2" type="checkbox" name="service_ids" value="{{ service.id }}">
                  {{ service.name_jp if lang == 'jp' else service.name_cn }}
                  <span class="text-muted small">({{ service.price }} {{ service.currency }})</span>
                </label>
              {% else %}
                <div class="text-muted small">-</div>
              {% endfor %}
            </div>
          </div>
          <div class="col-12">
            <label class="form-label">{{ t('portal.rental_note_label') }}</label>
            <textarea class="form-control" name="note" rows="3"></textarea>
          </div>
          <div class="col-12">
            <button class="btn btn-primary w-100">{{ t('portal.rentals_apply_cta') }}</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const mainImage = document.getElementById('rental-main-image');
  document.getElementById('rental-photo-thumbs')?.addEventListener('click', (event) => {
    const button = event.target.closest('.rental-thumb');
    if (!button || !mainImage) {
      return;
    }
    const filename = button.dataset.filename;
    if (!filename) {
      return;
    }
    mainImage.src = "{{ url_for('portal.portal_vehicle_image', vin=vehicle.vin, category='vehicle_photo', filename='__PLACEHOLDER__') }}".replace('__PLACEHOLDER__', filename);
  });

  const mapContainer = document.getElementById('rental-map');
  if (mapContainer && window.L) {
    const defaultLatLng = [35.681236, 139.767125];
    const map = L.map(mapContainer).setView(defaultLatLng, 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);
    let marker = null;
    const latInput = document.getElementById('delivery-lat');
    const lngInput = document.getElementById('delivery-lng');
    const addressInput = document.getElementById('delivery-address');
    const hint = document.getElementById('rental-location-hint');

    const setMarker = (lat, lng) => {
      if (marker) {
        map.removeLayer(marker);
      }
      marker = L.marker([lat, lng]).addTo(map);
      const zoom = map.getZoom();
      map.setView([lat, lng], zoom);
      if (latInput && lngInput) {
        latInput.value = lat.toFixed(6);
        lngInput.value = lng.toFixed(6);
      }
      if (addressInput) {
        addressInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }
      if (hint) {
        hint.textContent = "{{ t('portal.rental_location_selected') }}: " + `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }
    };

    map.on('click', (event) => {
      setMarker(event.latlng.lat, event.latlng.lng);
    });

    if (window.confirm("{{ t('portal.rental_location_consent') }}") && navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((position) => {
        setMarker(position.coords.latitude, position.coords.longitude);
      });
    }
  }
</script>
{% endblock %}
