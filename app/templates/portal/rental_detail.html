{% extends 'portal/base.html' %}

{% set brand_label = (vehicle.brand_jp if lang == 'jp' else vehicle.brand_cn) or '-' %}
{% set model_label = (vehicle.model_jp if lang == 'jp' else vehicle.model_cn) or '-' %}

{% block page_title %}{{ t('portal.rental_detail_title') }}{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
{% endblock %}

{% block content %}
<div class="mb-3">
  <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('portal.portal_rentals', lang=lang) }}">
    {{ t('portal.rental_back') }}
  </a>
</div>

<div class="row g-4">
  <div class="col-lg-7">
    <div class="card p-3">
      <h5 class="mb-3">{{ t('portal.rental_gallery_title') }}</h5>
      {% if vehicle_photos %}
        {% set initial_photo = cover_filename or vehicle_photos[0].filename %}
        <div class="mb-3">
          <img id="rental-main-image" class="img-fluid rounded"
               src="{{ url_for('portal.portal_vehicle_image', vin=vehicle.vin, category='vehicle_photo', filename=initial_photo) }}"
               alt="{{ brand_label }} {{ model_label }}">
        </div>
        <div class="d-flex flex-wrap gap-2" id="rental-photo-thumbs">
          {% for photo in vehicle_photos %}
            <button type="button" class="btn p-0 border-0 rental-thumb" data-filename="{{ photo.filename }}">
              <img class="rounded" style="width: 96px; height: 72px; object-fit: cover;"
                   src="{{ url_for('portal.portal_vehicle_image', vin=vehicle.vin, category='vehicle_photo', filename=photo.filename) }}"
                   alt="{{ photo.filename }}">
            </button>
          {% endfor %}
        </div>
        <p class="text-muted small mt-2 mb-0">{{ t('portal.rental_thumbnail_hint') }}</p>
      {% else %}
        <div class="alert alert-secondary mb-0">{{ t('portal.rental_no_photos') }}</div>
      {% endif %}
    </div>
  </div>
  <div class="col-lg-5">
    <div class="card p-3 mb-3">
      <h5 class="mb-2">{{ brand_label }} / {{ model_label }}</h5>
      <div class="text-muted">{{ t('portal.rentals_mileage') }}: {{ status.mileage if status.mileage is not none else '-' }} km</div>
      <div class="text-muted">{{ t('portal.rental_year_label') }}: {{ vehicle.model_year_ad or '-' }}</div>
      <div class="text-muted">{{ t('portal.rental_store_label') }}: {{ vehicle.store_name or '-' }}</div>
    </div>
    <div class="card p-3">
      <h5 class="mb-2">{{ t('portal.rental_description_title') }}</h5>
      {% if vehicle.note %}
        <p class="mb-0">{{ vehicle.note }}</p>
      {% else %}
        <p class="text-muted mb-0">{{ t('portal.rental_description_empty') }}</p>
      {% endif %}
    </div>
    <div class="card p-3 mt-3">
      <h5 class="mb-3">{{ t('portal.rental_pricing_title') }}</h5>
      <div class="row g-2 small">
        <div class="col-md-6">
          <div class="d-flex justify-content-between text-muted">
            <span>{{ t('portal.rental_base_price_label') }}</span>
            <span data-pricing="daily">{{ pricing.daily_price if pricing and pricing.daily_price is not none else '-' }} {{ t('portal.rental_rate_unit') }}</span>
          </div>
          <div class="d-flex justify-content-between text-muted">
            <span>{{ t('portal.rental_deposit_label') }}</span>
            <span data-pricing="deposit">{{ pricing.deposit_amount if pricing and pricing.deposit_amount is not none else '-' }} {{ t('portal.rental_currency_unit') }}</span>
          </div>
          <div class="d-flex justify-content-between text-muted">
            <span>{{ t('portal.rental_insurance_label') }}</span>
            <span data-pricing="insurance">{{ pricing.insurance_per_day if pricing and pricing.insurance_per_day is not none else '-' }} {{ t('portal.rental_rate_unit') }}</span>
          </div>
          <div class="d-flex justify-content-between text-muted">
            <span>{{ t('portal.rental_free_km_label') }}</span>
            <span>{{ pricing.free_km_per_day if pricing and pricing.free_km_per_day is not none else '-' }} {{ t('portal.rental_distance_unit') }}</span>
          </div>
        </div>
        <div class="col-md-6">
          <div class="d-flex justify-content-between text-muted">
            <span>{{ t('portal.rental_extra_km_label') }}</span>
            <span data-pricing="extra_km">{{ pricing.extra_km_price if pricing and pricing.extra_km_price is not none else '-' }} {{ t('portal.rental_currency_unit') }}</span>
          </div>
          <div class="d-flex justify-content-between text-muted">
            <span>{{ t('portal.rental_cleaning_fee_label') }}</span>
            <span data-pricing="cleaning">{{ pricing.cleaning_fee if pricing and pricing.cleaning_fee is not none else '-' }} {{ t('portal.rental_currency_unit') }}</span>
          </div>
          <div class="d-flex justify-content-between text-muted">
            <span>{{ t('portal.rental_late_fee_label') }}</span>
            <span>{{ pricing.late_fee_per_day if pricing and pricing.late_fee_per_day is not none else '-' }} {{ t('portal.rental_rate_unit') }}</span>
          </div>
          <div class="d-flex justify-content-between text-muted">
            <span>{{ t('portal.rental_tax_rate_label') }}</span>
            <span>{{ pricing.tax_rate if pricing and pricing.tax_rate is not none else '-' }}%</span>
          </div>
        </div>
      </div>
    </div>
    <div class="card p-3 mt-3">
      <h5 class="mb-3">{{ t('portal.rental_apply_section_title') }}</h5>
      {% if submitted %}
        <div class="alert alert-success">{{ t('portal.rental_submit_success') }}</div>
      {% endif %}
      {% if error == 'dates' %}
        <div class="alert alert-warning">{{ t('portal.rental_date_required') }}</div>
      {% endif %}
      {% if error == 'delivery' %}
        <div class="alert alert-warning">{{ t('portal.rental_delivery_required') }}</div>
      {% endif %}
      {% if not current_customer.is_authenticated %}
        <div class="alert alert-warning">{{ t('portal.rental_login_hint') }}</div>
      {% endif %}
      <form method="post" action="{{ url_for('portal.portal_rental_request', vehicle_id=vehicle.id, lang=lang) }}">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">{{ t('portal.rental_date_start') }}</label>
            <input type="date" class="form-control" name="start_date" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">{{ t('portal.rental_date_end') }}</label>
            <input type="date" class="form-control" name="end_date" required>
          </div>
          <div class="col-12">
            <label class="form-label">{{ t('portal.rental_pickup_title') }}</label>
            <div class="d-flex flex-wrap gap-3">
              <label class="form-check-label">
                <input class="form-check-input me-2" type="radio" name="pickup_method" value="store" checked>
                {{ t('portal.rental_pickup_store') }}
              </label>
              <label class="form-check-label">
                <input class="form-check-input me-2" type="radio" name="pickup_method" value="address">
                {{ t('portal.rental_pickup_address') }}
              </label>
            </div>
            <div class="mt-2" data-pickup="store">
              <select class="form-select" name="pickup_store_id">
                {% for store in stores %}
                  <option value="{{ store.id }}" {% if vehicle.garage_store_id == store.id %}selected{% endif %}>
                    {{ store.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="mt-2 d-none" data-pickup="address">
              <div class="border rounded" id="pickup-map" style="height: 200px;"></div>
              <div class="text-muted small mt-2" id="pickup-location-hint">{{ t('portal.rental_location_hint') }}</div>
              <input type="hidden" name="pickup_lat" id="pickup-lat">
              <input type="hidden" name="pickup_lng" id="pickup-lng">
              <input type="hidden" name="pickup_address" id="pickup-address">
            </div>
          </div>
          <div class="col-12">
            <label class="form-label">{{ t('portal.rental_dropoff_title') }}</label>
            <div class="d-flex flex-wrap gap-3">
              <label class="form-check-label">
                <input class="form-check-input me-2" type="radio" name="dropoff_method" value="store" checked>
                {{ t('portal.rental_dropoff_store') }}
              </label>
              <label class="form-check-label">
                <input class="form-check-input me-2" type="radio" name="dropoff_method" value="address">
                {{ t('portal.rental_dropoff_address') }}
              </label>
            </div>
            <div class="mt-2" data-dropoff="store">
              <select class="form-select" name="dropoff_store_id">
                {% for store in stores %}
                  <option value="{{ store.id }}">{{ store.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mt-2 d-none" data-dropoff="address">
              <div class="border rounded" id="dropoff-map" style="height: 200px;"></div>
              <div class="text-muted small mt-2" id="dropoff-location-hint">{{ t('portal.rental_location_hint') }}</div>
              <input type="hidden" name="dropoff_lat" id="dropoff-lat">
              <input type="hidden" name="dropoff_lng" id="dropoff-lng">
              <input type="hidden" name="dropoff_address" id="dropoff-address">
            </div>
          </div>
          <div class="col-12">
            <label class="form-label">{{ t('portal.rental_services_label') }}</label>
            <div class="d-flex flex-column gap-2">
              {% for service in rental_services %}
                <label class="form-check-label">
                  <input class="form-check-input me-2" type="checkbox" name="service_ids" value="{{ service.id }}"
                         data-service-price="{{ service.price }}" data-service-type="{{ service.pricing_type }}">
                  {{ service.name_jp if lang == 'jp' else service.name_cn }}
                  <span class="text-muted small">({{ service.price }} {{ service.currency }})</span>
                </label>
              {% else %}
                <div class="text-muted small">-</div>
              {% endfor %}
            </div>
          </div>
          <div class="col-12">
            <label class="form-label">{{ t('portal.rental_note_label') }}</label>
            <textarea class="form-control" name="note" rows="3"></textarea>
          </div>
          <div class="col-12">
            <div class="d-flex justify-content-between border rounded p-2 bg-light">
              <span class="text-muted">{{ t('portal.rental_estimated_total') }}</span>
              <span class="fw-semibold" id="rental-estimated-total">-</span>
            </div>
            <div class="text-muted small mt-1">{{ t('portal.rental_estimated_note') }}</div>
          </div>
          <div class="col-12">
            <button class="btn btn-primary w-100">{{ t('portal.rentals_apply_cta') }}</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const mainImage = document.getElementById('rental-main-image');
  document.getElementById('rental-photo-thumbs')?.addEventListener('click', (event) => {
    const button = event.target.closest('.rental-thumb');
    if (!button || !mainImage) {
      return;
    }
    const filename = button.dataset.filename;
    if (!filename) {
      return;
    }
    mainImage.src = "{{ url_for('portal.portal_vehicle_image', vin=vehicle.vin, category='vehicle_photo', filename='__PLACEHOLDER__') }}".replace('__PLACEHOLDER__', filename);
  });

  const setupLocationMap = (mapId, latId, lngId, addressId, hintId) => {
    const container = document.getElementById(mapId);
    if (!container || !window.L) {
      return null;
    }
    const defaultLatLng = [35.681236, 139.767125];
    const map = L.map(container).setView(defaultLatLng, 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors',
    }).addTo(map);
    let marker = null;
    const latInput = document.getElementById(latId);
    const lngInput = document.getElementById(lngId);
    const addressInput = document.getElementById(addressId);
    const hint = document.getElementById(hintId);

    const setMarker = (lat, lng) => {
      if (marker) {
        map.removeLayer(marker);
      }
      marker = L.marker([lat, lng]).addTo(map);
      map.setView([lat, lng], map.getZoom());
      if (latInput && lngInput) {
        latInput.value = lat.toFixed(6);
        lngInput.value = lng.toFixed(6);
      }
      if (addressInput) {
        addressInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }
      if (hint) {
        hint.textContent = "{{ t('portal.rental_location_selected') }}: " + `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
      }
      updateTotal();
    };

    map.on('click', (event) => {
      setMarker(event.latlng.lat, event.latlng.lng);
    });

    return { map, setMarker };
  };

  const pickupMap = setupLocationMap('pickup-map', 'pickup-lat', 'pickup-lng', 'pickup-address', 'pickup-location-hint');
  const dropoffMap = setupLocationMap('dropoff-map', 'dropoff-lat', 'dropoff-lng', 'dropoff-address', 'dropoff-location-hint');

  const consentKey = 'rentalLocationConsent';
  const consented = localStorage.getItem(consentKey) === 'true';
  if (!consented) {
    const accepted = window.confirm("{{ t('portal.rental_location_consent') }}");
    if (accepted) {
      localStorage.setItem(consentKey, 'true');
    }
  }
  if (localStorage.getItem(consentKey) === 'true' && navigator.geolocation) {
    navigator.geolocation.getCurrentPosition((position) => {
      pickupMap?.setMarker(position.coords.latitude, position.coords.longitude);
    });
  }

  const toggleSections = (name, value) => {
    document.querySelectorAll(`[data-${name}]`).forEach((el) => {
      el.classList.toggle('d-none', el.dataset[name] !== value);
    });
  };
  document.querySelectorAll('input[name=\"pickup_method\"]').forEach((input) => {
    input.addEventListener('change', (event) => {
      toggleSections('pickup', event.target.value);
      updateTotal();
    });
  });
  document.querySelectorAll('input[name=\"dropoff_method\"]').forEach((input) => {
    input.addEventListener('change', (event) => {
      toggleSections('dropoff', event.target.value);
      updateTotal();
    });
  });

  const totalEl = document.getElementById('rental-estimated-total');
  const startInput = document.querySelector('input[name=\"start_date\"]');
  const endInput = document.querySelector('input[name=\"end_date\"]');
  const serviceInputs = document.querySelectorAll('input[name=\"service_ids\"]');
  const dailyPrice = Number(document.querySelector('[data-pricing=\"daily\"]')?.textContent?.trim().split(' ')[0]) || 0;
  const insurancePrice = Number(document.querySelector('[data-pricing=\"insurance\"]')?.textContent?.trim().split(' ')[0]) || 0;
  const cleaningFee = Number(document.querySelector('[data-pricing=\"cleaning\"]')?.textContent?.trim().split(' ')[0]) || 0;
  const storeData = {{ stores | tojson }};
  const deliveryTiers = {{ delivery_tiers | tojson }};
  const baseStoreId = {{ vehicle.garage_store_id or 1 }};
  const pickupMethodInputs = document.querySelectorAll('input[name=\"pickup_method\"]');
  const dropoffMethodInputs = document.querySelectorAll('input[name=\"dropoff_method\"]');
  const pickupStoreSelect = document.querySelector('select[name=\"pickup_store_id\"]');
  const dropoffStoreSelect = document.querySelector('select[name=\"dropoff_store_id\"]');
  const pickupLatInput = document.getElementById('pickup-lat');
  const pickupLngInput = document.getElementById('pickup-lng');
  const dropoffLatInput = document.getElementById('dropoff-lat');
  const dropoffLngInput = document.getElementById('dropoff-lng');

  const calculateDays = () => {
    if (!startInput?.value || !endInput?.value) {
      return 0;
    }
    const start = new Date(startInput.value);
    const end = new Date(endInput.value);
    const diff = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
    return diff > 0 ? diff : 0;
  };

  const toNumber = (value) => {
    const parsed = Number(value);
    return Number.isFinite(parsed) ? parsed : null;
  };

  const distanceKm = (lat1, lng1, lat2, lng2) => {
    if ([lat1, lng1, lat2, lng2].some((v) => v === null)) {
      return null;
    }
    const r = 6371;
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat / 2) ** 2 +
      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
      Math.sin(dLng / 2) ** 2;
    return r * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  };

  const tierFee = (distance) => {
    if (distance === null) {
      return 0;
    }
    for (const tier of deliveryTiers) {
      const minKm = Number(tier.min_km);
      const maxKm = tier.max_km === null ? null : Number(tier.max_km);
      if (distance >= minKm && (maxKm === null || distance <= maxKm)) {
        return Number(tier.fee_amount) || 0;
      }
    }
    return 0;
  };

  const findStore = (storeId) => storeData.find((store) => Number(store.id) === Number(storeId));

  const updateTotal = () => {
    const days = calculateDays();
    let total = 0;
    if (days > 0) {
      total += days * (dailyPrice + insurancePrice);
      total += cleaningFee;
      serviceInputs.forEach((input) => {
        if (!input.checked) {
          return;
        }
        const price = Number(input.dataset.servicePrice) || 0;
        const type = input.dataset.serviceType || 'per_booking';
        if (type === 'per_day') {
          total += price * days;
        } else {
          total += price;
        }
      });
      const baseStore = findStore(baseStoreId) || findStore(1);
      const baseLat = toNumber(baseStore?.lat);
      const baseLng = toNumber(baseStore?.lng);
      const pickupMethod = [...pickupMethodInputs].find((input) => input.checked)?.value;
      const dropoffMethod = [...dropoffMethodInputs].find((input) => input.checked)?.value;
      let pickupFee = 0;
      let dropoffFee = 0;
      if (pickupMethod === 'address') {
        const dist = distanceKm(baseLat, baseLng, toNumber(pickupLatInput?.value), toNumber(pickupLngInput?.value));
        pickupFee = tierFee(dist);
      }
      if (dropoffMethod === 'address') {
        const dist = distanceKm(baseLat, baseLng, toNumber(dropoffLatInput?.value), toNumber(dropoffLngInput?.value));
        dropoffFee = tierFee(dist);
      } else if (dropoffMethod === 'store') {
        const dropoffStore = findStore(dropoffStoreSelect?.value);
        if (dropoffStore && baseStore && Number(dropoffStore.id) !== Number(baseStore.id)) {
          const dist = distanceKm(baseLat, baseLng, toNumber(dropoffStore.lat), toNumber(dropoffStore.lng));
          dropoffFee = tierFee(dist) * 0.5;
        }
      }
      total += pickupFee + dropoffFee;
    }
    totalEl.textContent = total ? `${total} {{ t('portal.rental_currency_unit') }}` : '-';
  };

  startInput?.addEventListener('change', updateTotal);
  endInput?.addEventListener('change', updateTotal);
  serviceInputs.forEach((input) => input.addEventListener('change', updateTotal));
  pickupStoreSelect?.addEventListener('change', updateTotal);
  dropoffStoreSelect?.addEventListener('change', updateTotal);
  updateTotal();
</script>
{% endblock %}
